local HttpService = game:GetService("HttpService")
local SaveManager = {}
SaveManager.Library = nil
SaveManager.Folder = "FluentXPSettings"
SaveManager.Ignore = {}
SaveManager.Theme = true
local function MakeFolder(path)
    if not isfolder(path) then
        makefolder(path)
    end
end
local function Encode(data)
    return HttpService:JSONEncode(data)
end
local function Decode(data)
    return HttpService:JSONDecode(data)
end
function SaveManager:SetLibrary(Library)
    self.Library = Library
end

function SaveManager:IgnoreThemeSettings(state)
    self.Theme = not state
end
function SaveManager:Save(name)
    if not self.Library then return end
    MakeFolder(self.Folder)
    local data = {
        Options = {},
        Theme = {},
    }
    for i,v in pairs(self.Library.Options or {}) do
        if not table.find(self.Ignore, i) then
            pcall(function()
                data.Options[i] = v.Value
            end)
        end
    end
    if self.Theme and self.Library.Theme then
        for k,v in pairs(self.Library.Theme) do
            if typeof(v) == "Color3" then
                data.Theme[k] = {v.R, v.G, v.B}
            end
        end
    end
    writefile(self.Folder.."/"..name..".json", Encode(data))
end
function SaveManager:Load(name)
    if not self.Library then return end
    if not isfile(self.Folder.."/"..name..".json") then return end
    local data = Decode(readfile(self.Folder.."/"..name..".json"))
    if data.Options then
        for i,v in pairs(data.Options) do
            local option = self.Library.Options[i]
            if option then
                pcall(function()
                    option:SetValue(v)
                end)
            end
        end
    end
    if self.Theme and data.Theme and self.Library then
        for k,v in pairs(data.Theme) do
            if self.Library.UpdateColor then
                self.Library:UpdateColor(k, Color3.new(v[1], v[2], v[3]))
            elseif self.Library.Theme then
                self.Library.Theme[k] = Color3.new(v[1], v[2], v[3])
            end
        end

        if self.Library.ApplyTheme then
            self.Library:ApplyTheme()
        end
    end
end
function SaveManager:GetConfigs()
    MakeFolder(self.Folder)

    local files = {}
    for _,file in pairs(listfiles(self.Folder)) do
        table.insert(files, file:gsub(self.Folder.."/",""):gsub(".json",""))
    end
    return files
end

return SaveManager
