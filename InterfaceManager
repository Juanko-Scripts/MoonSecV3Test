local HttpService = game:GetService("HttpService")

local SaveManager = {}
SaveManager.Library = nil
SaveManager.Folder = "FluentXPSettings"
SaveManager.Ignore = {}
SaveManager.Options = {}

local function MakeFolder(path)
    if not isfolder(path) then
        makefolder(path)
    end
end

local function Encode(t)
    return HttpService:JSONEncode(t)
end

local function Decode(t)
    return HttpService:JSONDecode(t)
end

function SaveManager:SetLibrary(lib)
    self.Library = lib
    self.Options = lib.Flags or lib.Options or {}
end

function SaveManager:Save(name)
    if not self.Library then return end
    MakeFolder(self.Folder)

    local data = {}

    for i,v in pairs(self.Options) do
        if not table.find(self.Ignore, i) then
            pcall(function()
                if typeof(v) == "table" and v.Value ~= nil then
                    data[i] = v.Value
                else
                    data[i] = v
                end
            end)
        end
    end

    writefile(self.Folder.."/"..name..".json", Encode(data))
end

function SaveManager:Load(name)
    if not self.Library then return end
    local file = self.Folder.."/"..name..".json"
    if not isfile(file) then return end

    local data = Decode(readfile(file))

    for i,v in pairs(data) do
        local opt = self.Options[i]
        if opt then
            pcall(function()
                if opt.Set then
                    opt:Set(v)
                elseif opt.SetValue then
                    opt:SetValue(v)
                else
                    opt.Value = v
                end
            end)
        end
    end
end

function SaveManager:GetConfigs()
    MakeFolder(self.Folder)
    local files = {}

    for _,file in pairs(listfiles(self.Folder)) do
        if file:sub(-5) == ".json" then
            table.insert(files, file:match(".+/(.+)%.json"))
        end
    end
    return files
end

function SaveManager:Delete(name)
    local f = self.Folder.."/"..name..".json"
    if isfile(f) then
        delfile(f)
    end
end

function SaveManager:BuildConfigSection(tab)
    local Group = tab:AddGroup("Config Manager")

    Group:AddTextbox("ConfigName", {
        Title = "Config Name",
        Default = "myconfig"
    })

    Group:AddDropdown("ConfigList", {
        Title = "Configs",
        Values = self:GetConfigs()
    })

    Group:AddButton("Save Config", function()
        local name = self.Library.Flags.ConfigName.Value
        self:Save(name)
    end)

    Group:AddButton("Load Config", function()
        local name = self.Library.Flags.ConfigList.Value
        self:Load(name)
    end)

    Group:AddButton("Delete Config", function()
        local name = self.Library.Flags.ConfigList.Value
        self:Delete(name)
    end)

    Group:AddButton("Refresh List", function()
        self.Library.Flags.ConfigList:Refresh(self:GetConfigs())
    end)
end

return SaveManager